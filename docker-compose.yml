version: "3.9"

services:
  # ==========================================
  # SHARED INFRASTRUCTURE
  # ==========================================
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: rabbitmq
    restart: always
    ports:
      - "${RABBITMQ_EXTERNAL_PORT}:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASS}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - microservices-net

  # ==========================================
  # USER SERVICE
  # ==========================================
  user_db:
    image: mongo:7.0
    container_name: user_mongo
    restart: always
    volumes:
      - user_db_data:/data/db
    networks:
      - microservices-net

  user_service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    container_name: user_service
    restart: on-failure
    depends_on:
      - user_db
      - rabbitmq
    ports:
      - "4000:4000"
    environment:
      PORT: 4000
      USER_MONGO_URI: mongodb://user_db:27017/userdb
      JWT_SECRET: ${JWT_SECRET}
      RABBITMQ_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASS}@rabbitmq:5672
    networks:
      - microservices-net

  # ==========================================
  # PRODUCT SERVICE
  # ==========================================
  product_db:
    image: mongo:7.0
    container_name: product_mongo
    restart: always
    volumes:
      - product_db_data:/data/db
    networks:
      - microservices-net

  product_service:
    build:
      context: ./services/product-service
      dockerfile: Dockerfile
    container_name: product_service
    restart: on-failure
    depends_on:
      - product_db
      - rabbitmq
    ports:
      - "5001:5001"
    environment:
      PORT: 5001
      PRODUCT_MONGO_URI: mongodb://product_db:27017/productdb
      JWT_SECRET: ${JWT_SECRET}
      RABBITMQ_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASS}@rabbitmq:5672
    networks:
      - microservices-net

  # ==========================================
  # ORDER SERVICE
  # ==========================================
  order_db:
    image: postgres:15-alpine
    container_name: order_db
    restart: always
    environment:
      POSTGRES_USER: ${ORDER_DB_USER}
      POSTGRES_PASSWORD: ${ORDER_DB_PASS}
      POSTGRES_DB: ${ORDER_DB_NAME}
    volumes:
      - order_db_data:/var/lib/postgresql/data
    networks:
      - microservices-net

  order_service:
    build:
      context: ./services/order-service
      dockerfile: Dockerfile
    container_name: order_service
    restart: on-failure
    depends_on:
      - order_db
      - rabbitmq
    ports:
      - "3000:3000"
    environment:
      PORT: 3000
      DB_HOST: order_db
      DB_PORT: 5432
      DB_NAME: ${ORDER_DB_NAME}
      DB_USER: ${ORDER_DB_USER}
      DB_PASSWORD: ${ORDER_DB_PASS}
      JWT_SECRET: ${JWT_SECRET}
      RABBITMQ_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASS}@rabbitmq:5672
    networks:
      - microservices-net

  # ==========================================
  # PAYMENT SERVICE
  # ==========================================
  payment_db:
    image: postgres:15-alpine
    container_name: payment_db
    restart: always
    environment:
      POSTGRES_USER: ${PAYMENT_DB_USER}
      POSTGRES_PASSWORD: ${PAYMENT_DB_PASS}
      POSTGRES_DB: ${PAYMENT_DB_NAME}
    volumes:
      - payment_db_data:/var/lib/postgresql/data
    networks:
      - microservices-net

  payment_service:
    build:
      context: ./services/payment-service
      dockerfile: Dockerfile
    container_name: payment_service
    restart: on-failure
    depends_on:
      - payment_db
      - rabbitmq
    ports:
      - "3001:3000"
    environment:
      PORT: 3000
      DB_HOST: payment_db
      DB_PORT: 5432
      DB_NAME: ${PAYMENT_DB_NAME}
      DB_USER: ${PAYMENT_DB_USER}
      DB_PASSWORD: ${PAYMENT_DB_PASS}
      JWT_SECRET: ${JWT_SECRET}
      RABBITMQ_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASS}@rabbitmq:5672
    networks:
      - microservices-net

# ==========================================
# VOLUMES & NETWORK
# ==========================================
volumes:
  rabbitmq_data:
  user_db_data:
  product_db_data:
  order_db_data:
  payment_db_data:

networks:
  microservices-net:
    driver: bridge
